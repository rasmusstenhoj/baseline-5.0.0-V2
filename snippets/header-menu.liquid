{%- liquid
  assign dropdown_style = section.settings.dropdown_style
  assign link_all = section.settings.show_all_navigation_links
  assign dropdown_text_align = section.settings.dropdown_text_align
  assign show_collection_count_top = section.settings.show_collection_count
  assign show_collection_count_dropdown = section.settings.show_collection_count_dropdown
  assign show_top_level_menu_link_dropdown = section.settings.show_top_level_menu_link_dropdown

  assign menu_style = layout | split: 'menu_' | last
  assign counter = 0

  if menu_style == 'center' or menu_style == 'below'
    assign parent_list_classes = 'justify-center'
  elsif menu_style == 'left'
    assign parent_list_classes = 'justify-start'
  elsif menu_style == 'right'
    assign parent_list_classes = 'justify-end'
  endif

  case dropdown_text_align
    when 'text-left'
      assign single_level_menu_flex_justify = 'justify-start'
    when 'text-center'
      assign single_level_menu_flex_justify = 'justify-center'
    when 'text-right'
      assign single_level_menu_flex_justify = 'justify-end'
  endcase

  assign block_separator = '<!--FEATURE_IMAGE_BLOCK_SEPARATOR-->'
  assign sizes = '[SIZES]'
  assign feature_images_blocks = ''
  assign feature_images_blocks_menu_names = ''
  assign feature_images_blocks_image_counts = ''

  if settings.grid_media_style == 'fill' and dropdown_style == 'columns'
    assign always_show_border_radius = true
  endif
-%}

{%- for block in section.blocks -%}
  {%- assign image_count = 0 -%}

  {%- # white-space: normal -%}
  {%- capture feature_image_block -%}
    {% if dropdown_style == 'columns' %}
      <div class="flex basis-2/5 justify-end gap-4">
    {% endif %}

    {% assign ratio = block.settings.crop | plus: 0 %}

    {% for i in (1..3) %}
      {% liquid
        assign image_key = 'image_' | append: i
        assign image = block.settings[image_key]
        assign text_key = 'text_' | append: i
        assign text = block.settings[text_key]
        assign cta_link_key = 'cta_link_' | append: i
        assign cta_link = block.settings[cta_link_key]

        if i == 1
          assign show_image = true
        else
          assign show_image_key = 'show_image_' | append: i
          assign show_image = block.settings[show_image_key]
        endif

        if show_image
          assign image_count = image_count | plus: 1
        endif
      %}

      {% if show_image or i == 1 %}
        <div class="bg-scheme-background text-scheme-text {% if dropdown_style == 'columns' %}flex-1 min-w-1/4 max-w-3/5{% endif %}">
          {% if cta_link != blank %}
            <a
              class="focus-inset group/zoom block h-full focus-visible:relative"
              href="{{ cta_link }}"
              {% if text != blank %}
                aria-label="{{ text }}"
              {% endif %}
            >
          {% endif %}

          <div class="{% if settings.grid_media_style == 'inset' and dropdown_style == 'grid' %}p-grid-media{% endif %}{% if settings.grid_media_style == 'fill' and dropdown_style == 'grid' %} border-b-gridline border-gridline-color{% endif %}{% if text == blank %} -mb-gridline{% endif %}">
            {% if image == blank %}
              {% render 'image-crop-placeholder',
                ratio: ratio,
                always_show_border_radius: always_show_border_radius
              %}
            {% else %}
              {%- liquid
                assign preload = false
                assign loading = 'lazy'

                render 'image-crop', image: image, ratio: ratio, sizes: sizes, preload: preload, loading: loading, always_show_border_radius: always_show_border_radius
              -%}
            {% endif %}
          </div>

          {% if text != blank %}
            <div class="{% unless dropdown_style == 'columns' %}p-4{% else %}mt-4{% endunless %}">
              <p
                class="{{ section.settings.dropdown_text_align }}"
                aria-hidden="true"
              >
                {{- text -}}
              </p>
            </div>
          {% endif %}

          {% if cta_link != blank %}
            </a>
          {% endif %}
        </div>
      {% endif %}
    {% endfor %}

    {% if dropdown_style == 'columns' %}
      </div>
    {% endif %}
  {%- endcapture -%}

  {%- liquid
    assign menu_name_downcase = block.settings.menu_name | downcase
    assign feature_images_blocks = feature_images_blocks | append: feature_image_block
    assign feature_images_blocks_menu_names = feature_images_blocks_menu_names | append: menu_name_downcase
    assign feature_images_blocks_image_counts = feature_images_blocks_image_counts | append: image_count

    unless forloop.last
      assign feature_images_blocks = feature_images_blocks | append: block_separator
      assign feature_images_blocks_menu_names = feature_images_blocks_menu_names | append: ','
      assign feature_images_blocks_image_counts = feature_images_blocks_image_counts | append: ','
    endunless
  -%}
{%- endfor -%}

{%- liquid
  assign feature_images_blocks = feature_images_blocks | split: block_separator
  assign feature_images_blocks_menu_names = feature_images_blocks_menu_names | split: ','
  assign feature_images_blocks_image_counts = feature_images_blocks_image_counts | split: ','
-%}

{%- unless layout contains 'spread' -%}
  <ul
    class="flex flex-wrap content-center items-stretch gap-x-4 self-stretch {{ parent_list_classes }}"
  >
{%- endunless -%}

{%- for link in linklists[section.settings.menu].links -%}
  {%- liquid
    assign dropdown_type = ''
    assign links_without_children = link.links | where: 'levels', 0
    assign links_with_children = link.links | where: 'levels', 1

    assign link_title_downcase = link.title | downcase
    assign has_featured_images_block = false

    assign matching_index = feature_images_blocks_menu_names | find_index: link_title_downcase

    if matching_index >= 0
      assign has_featured_images_block = true
      assign featured_images_block = feature_images_blocks[matching_index]
      assign image_count = feature_images_blocks_image_counts[matching_index]
    endif

    if link.levels == 1
      if has_featured_images_block
        assign dropdown_type = 'single_with_featured_images'
      else
        assign dropdown_type = 'single'
      endif
    elsif link.levels == 2
      if links_without_children.size == 0
        assign dropdown_type = 'mega'
      else
        assign dropdown_type = 'mixed'
      endif
    endif

    assign child_menu = ''
    assign grandchild_menu = ''

    assign dropdown_wrapper_class = 'px-section-horizontal-spacing'
    assign dropdown_item_class = 'bg-scheme-background text-scheme-text'

    if dropdown_style == 'grid'
      assign dropdown_item_class = dropdown_item_class | append: ' px-section-horizontal-spacing py-section-vertical-spacing'

      assign total_link_groups = 0

      if links_without_children.size > 0
        assign total_link_groups = total_link_groups | plus: 1
      endif

      if links_with_children.size > 0
        assign dropdown_wrapper_class = ''
        assign total_link_groups = total_link_groups | plus: links_with_children.size
      endif

      unless dropdown_type contains 'single'
        if link_all
          if show_top_level_menu_link_dropdown
            assign total_link_groups = total_link_groups | plus: 1
          endif
        endif
      endunless

      if has_featured_images_block
        assign total_link_groups = total_link_groups | plus: image_count
        if link.levels == 1
          assign dropdown_wrapper_class = ''
        endif
      endif

      if dropdown_type == 'single_with_featured_images'
        assign grid_class = 'grid-cols-4'
        assign sizes = '(min-width: 1024px) calc(100vw / 4)'
        case image_count
          when '1'
            assign links_col_span_class = 'col-span-3'
          when '2'
            assign links_col_span_class = 'col-span-2'
          when '3'
            assign links_col_span_class = 'col-span-1'
        endcase
        assign dropdown_remainder_cols = 0
      else
        assign divisible_by_five = total_link_groups | modulo: 5
        assign divisible_by_three = total_link_groups | modulo: 3
        if divisible_by_five == 0
          assign cols_float = 5.0
          assign grid_class = 'grid-cols-5'
          assign sizes = '(min-width: 1024px) calc(100vw / 5)'
        elsif divisible_by_three == 0
          assign cols_float = 3.0
          assign grid_class = 'grid-cols-3'
          assign sizes = '(min-width: 1024px) calc(100vw / 3)'
        else
          assign cols_float = 4.0
          assign grid_class = 'grid-cols-4'
          assign sizes = '(min-width: 1024px) calc(100vw / 4)'
        endif

        assign dropdown_rows = total_link_groups | divided_by: cols_float | ceil
        assign dropdown_cols = cols_float | round
        assign dropdown_max_items = dropdown_cols | times: dropdown_rows
        assign dropdown_remainder_cols = dropdown_max_items | minus: total_link_groups | round
      endif

      assign dropdown_container_class = 'grid gap-gutter bg-gridline-color ' | append: grid_class

    else
      # Columns style #
      assign dropdown_container_class = 'flex py-4 gap-8'

      if has_featured_images_block
        case image_count
          when '1'
            assign sizes = '(min-width: 1024px) 40vw'
          when '2'
            assign sizes = '(min-width: 1024px) calc(40vw / 2)'
          when '3'
            assign sizes = '(min-width: 1024px) calc(40vw / 3)'
        endcase
      else
        if section.settings.layout contains 'menu_left'
          assign dropdown_container_class = dropdown_container_class | append: ' justify-left'
        else
          assign dropdown_container_class = dropdown_container_class | append: ' justify-center'
        endif
      endif
    endif

    assign featured_images_block = feature_images_blocks[matching_index] | replace: '[SIZES]', sizes
  -%}

  {%- if link.links != blank -%}
    {%- if link_all and show_top_level_menu_link_dropdown -%}
      {%- # white-space: normal -%}
      {% capture link_dropdown %}
        <div class="{{ dropdown_item_class }}">
          <a
            {% if link.active %}
              aria-current="page"
            {% endif %}
            class="{{ section.settings.dropdown_heading_font }} inline-block py-1 {% if settings.nav_uppercase and section.settings.dropdown_heading_font == 'font-body' %}uppercase{% endif %}"
            href="{{ link.url }}"
          >
            <span>{{- link.title -}}</span>
            {% if show_collection_count_dropdown
              and link.type == 'collection_link'
            %}
              <sup
                class="-ml-inline-sup"
                aria-label="{{ link.object.products_count }} {{ 'general.search.products' | t }}"
              >
                {{- link.object.products_count -}}
              </sup>
            {% endif %}
          </a>
        </div>
      {% endcapture %}
    {%- endif -%}

    {%- for child_link in link.links -%}
      {%- comment -%}
        Link has children
      {%- endcomment -%}
      {%- if link.levels == 2 -%}
        {%- comment -%}
          If child link has children, capture grandchild_menu
        {%- endcomment -%}
        {% if child_link.links != blank %}
          {%- # white-space: normal -%}
          {%- capture grandchild_menu %}
            {{- grandchild_menu -}}
            <div class="{{ dropdown_item_class }}">
              <h2 class="{{ section.settings.dropdown_heading_font }} mb-2 {% if settings.nav_uppercase and section.settings.dropdown_heading_font == 'font-body' %}uppercase{% endif %}">
                {% if link_all %}
                  <a
                    {% if child_link.active %}
                      aria-current="page"
                    {% endif %}
                    class="inline-block py-1 {% if settings.nav_uppercase %}uppercase{% endif %}"
                    href="{{ child_link.url }}"
                    {% if child_link.active %}
                      aria-current="page"
                    {% endif %}
                  >
                    <span>{{- child_link.title -}}</span>
                    {% if show_collection_count_dropdown
                      and child_link.type == 'collection_link'
                    %}
                      <sup
                        class="-ml-inline-sup"
                        aria-label="{{ child_link.object.products_count }} {{ 'general.search.products' | t }}"
                      >
                        {{- child_link.object.products_count -}}
                      </sup>
                    {% endif %}
                  </a>
                {% else %}
                  <span class="inline-block py-1">
                    {{ child_link.title }}
                  </span>
                {% endif %}
              </h2>
              <ul>
                {%- for grandchild_link in child_link.links -%}
                  <li class="">
                    <a
                      {% if grandchild_link.active %}
                        aria-current="page"
                      {% endif %}
                      class="inline-block py-1 {% if settings.nav_uppercase %}uppercase{% endif %}"
                      href="{{ grandchild_link.url }}"
                    >
                      <span>{{- grandchild_link.title -}}</span>
                      {% if show_collection_count_dropdown
                        and grandchild_link.type == 'collection_link'
                      %}
                        <sup
                          class="-ml-inline-sup"
                          aria-label="{{ grandchild_link.object.products_count }} {{ 'general.search.products' | t }}"
                        >
                          {{- grandchild_link.object.products_count -}}
                        </sup>
                      {% endif %}
                    </a>
                  </li>
                {%- endfor -%}
              </ul>
            </div>
          {%- endcapture -%}
        {%- else -%}
          {%- # white-space: normal -%}
          {%- capture child_menu %}
            {{- child_menu -}}
            <li>
              <a
                {% if child_link.active %}
                  aria-current="page"
                {% endif %}
                class="inline-block py-1 {% if settings.nav_uppercase %}uppercase{% endif %}"
                href="{{ child_link.url }}"
              >
                <span>{{- child_link.title -}}</span>
                {% if show_collection_count_dropdown
                  and child_link.type == 'collection_link'
                %}
                  <sup
                    class="-ml-inline-sup"
                    aria-label="{{ child_link.object.products_count }} {{ 'general.search.products' | t }}"
                  >
                    {{- child_link.object.products_count -}}
                  </sup>
                {% endif %}
              </a>
            </li>
          {%- endcapture -%}
        {%- endif -%}
      {%- else -%}
        {% comment %} Only second-level template {% endcomment %}
        {%- liquid
          assign link_class = 'inline-block'
          if has_featured_images_block
            assign link_class = 'inline-block py-1'
          endif
        -%}
        {%- # white-space: normal -%}
        {%- capture child_menu %}
          {{- child_menu -}}
          <li>
            <a
              {% if child_link.active %}
                aria-current="page"
              {% endif %}
              class="{{ link_class }} {% if settings.nav_uppercase %}uppercase{% endif %}"
              href="{{ child_link.url }}"
            >
              <span>{{- child_link.title -}}</span>
              {% if show_collection_count_dropdown
                and child_link.type == 'collection_link'
              %}
                <sup
                  class="-ml-inline-sup"
                  aria-label="{{ child_link.object.products_count }} {{ 'general.search.products' | t }}"
                >
                  {{- child_link.object.products_count -}}
                </sup>
              {% endif %}
            </a>
          </li>
        {%- endcapture -%}
      {%- endif -%}
    {%- endfor -%}

    {%- # white-space: normal -%}
    {%- capture link_item_content -%}
      <data-island
        x-data="{ expanded: false }"
        @focusout="if ($event.relatedTarget && !$el.contains($event.relatedTarget)) expanded = false"
        class="no-js-focus-wrapper flex self-stretch"
      >
        <button
          class="inline-flex {{ item_spacing }} items-center {% if settings.nav_uppercase and settings.header_font == 'body' %}uppercase{% endif %} {{ font_classes }}"
          @click="expanded = !expanded"
          :aria-expanded="expanded ? true : 'false'"
          aria-controls="menu{{ counter }}"
        >
          <span class="inline-block pr-1">{{ link.title }}</span>
          {%- if settings.accordion_icon == 'caret' -%}
            <span
              class="rotate mr-1 inline-block h-3 w-3 origin-center transform align-middle transition"
              :class="{ 'rotate-180' : expanded }"
            >
              {%- render 'icon-chevron-down' -%}
            </span>
          {%- else -%}
            <span
              class="mr-1 inline-block h-3 w-3 origin-center align-middle"
              x-show="!expanded"
            >
              {%- render 'icon-plus' -%}
            </span>
            <span
              class="mr-1 inline-block h-3 w-3 origin-center align-middle"
              x-show="expanded"
              style="display: none;"
            >
              {%- render 'icon-minus' -%}
            </span>
          {%- endif -%}
        </button>
        <div
          id="menu{{ counter }}"
          class="no-js-focus-container absolute bottom-auto left-0 top-full z-20 w-full border-y-gridline border-gridline-color bg-scheme-background text-scheme-text"
          x-cloak
          x-show="expanded"
          x-transition:enter="transition ease duration-200 motion-reduce:duration-0"
          x-transition:enter-start="opacity-0"
          x-transition:enter-end="opacity-100"
          x-transition:leave="transition ease duration-200 motion-reduce:duration-0"
          x-transition:leave-start="opacity-100"
          x-transition:leave-end="opacity-0"
          @click.outside.prevent="expanded = false"
          data-color-scheme="{{ section_color }}"
        >
          <div class="{{ dropdown_wrapper_class }} {{ dropdown_text_align }}">
            {%- case dropdown_type -%}
              {%- when 'single' -%}
                <ul class="flex gap-4 {{ item_spacing }} {{ single_level_menu_flex_justify }}">
                  {{ child_menu }}
                </ul>
              {%- when 'single_with_featured_images' -%}
                {% liquid
                  echo '<div class="'
                  echo dropdown_container_class
                  echo '">'
                  if dropdown_style == 'columns'
                    echo '<div class="flex gap-8 basis-3/5 flex-wrap">'
                  endif
                %}
                <ul class="{{ dropdown_item_class }} {{ links_col_span_class }}">
                  {{ child_menu }}
                </ul>
                {% liquid
                  if dropdown_style == 'grid'
                    echo featured_images_block
                  endif
                %}
                {%- if dropdown_remainder_cols > 0 -%}
                  <div
                    class="col-span-var bg-scheme-background"
                    style="--col-span: {{ dropdown_remainder_cols }};"
                    aria-hidden="true"
                    role="presentation"
                  ></div>
                {%- endif -%}
                {% liquid
                  echo '</div>'
                  if dropdown_style == 'columns'
                    echo featured_images_block
                    echo '</div>'
                  endif
                %}
              {%- when 'mixed' -%}
                <div class="{{ dropdown_container_class }}">
                  {% liquid
                    if dropdown_style == 'columns' and has_featured_images_block
                      echo '<div class="flex gap-8 basis-3/5 flex-wrap">'
                    endif
                  %}
                  {{ link_dropdown }}
                  <ul class="{{ dropdown_item_class }}">
                    {{ child_menu }}
                  </ul>
                  {{ grandchild_menu }}
                  {% liquid
                    if dropdown_style == 'grid' and has_featured_images_block
                      echo featured_images_block
                    endif
                  %}
                  {%- if dropdown_remainder_cols > 0 -%}
                    <div
                      class="col-span-var bg-scheme-background"
                      style="--col-span: {{ dropdown_remainder_cols }};"
                      aria-hidden="true"
                      role="presentation"
                    ></div>
                  {%- endif -%}
                  {% liquid
                    if dropdown_style == 'columns' and has_featured_images_block
                      echo '</div>'
                      echo featured_images_block
                    endif
                  %}
                </div>
              {%- when 'mega' -%}
                <div class="{{ dropdown_container_class }}">
                  {% liquid
                    if dropdown_style == 'columns' and has_featured_images_block
                      echo '<div class="flex gap-8 basis-3/5 flex-wrap">'
                    endif
                  %}
                  {{ link_dropdown }}
                  {{ grandchild_menu }}
                  {% liquid
                    if dropdown_style == 'grid' and has_featured_images_block
                      echo featured_images_block
                    endif
                  %}
                  {%- if dropdown_remainder_cols > 0 -%}
                    <div
                      class="col-span-var bg-scheme-background"
                      style="--col-span: {{ dropdown_remainder_cols }};"
                      aria-hidden="true"
                      role="presentation"
                    ></div>
                  {%- endif -%}
                  {% liquid
                    if dropdown_style == 'columns' and has_featured_images_block
                      echo '</div>'
                      echo featured_images_block
                    endif
                  %}
                </div>
            {%- endcase -%}
          </div>
        </div>
      </data-island>
    {%- endcapture -%}

    {%- unless layout contains 'spread' -%}
      <li class="flex self-stretch">
        {{ link_item_content }}
      </li>
    {%- else -%}
      {{ link_item_content }}
    {%- endunless -%}
    {% assign counter = counter | plus: 1 %}
  {%- else -%}
    {%- # white-space: normal -%}
    {% capture link_item_content %}
      <a
        {% if link.active %}
          aria-current="page"
        {% endif %}
        class="relative flex {{ item_spacing }} {% if layout contains 'spread' %}self-stretch inline-flex items-center{% endif %} {{ font_classes }} {% if settings.nav_uppercase and settings.header_font == 'body' %}uppercase{% endif %}"
        href="{{ link.url }}"
      >
        <span class="m-auto inline-block">{{- link.title -}}</span>
        {% if show_collection_count_top and link.type == 'collection_link' %}
          <sup
            class="{% unless layout contains 'spread' %}top-1{% endunless %}"
            aria-label="{{ link.object.products_count }} {{ 'general.search.products' | t }}"
          >
            {{- link.object.products_count -}}
          </sup>
        {% endif %}
        {% if section.settings.show_current_page_indicator %}
          {%- if link.active -%}
            <span
              class="absolute bottom-0 left-1/2 block h-2 w-gridline -translate-x-1/2 bg-gridline-color"
            ></span>
          {%- endif -%}
        {% endif %}
      </a>
    {% endcapture %}
    {%- unless layout contains 'spread' -%}
      <li class="inline-flex items-center">
        {{ link_item_content }}
      </li>
    {%- else -%}
      {{ link_item_content }}
    {%- endunless -%}
  {%- endif -%}
{%- endfor -%}
{%- unless layout contains 'spread' -%}
  </ul>
{%- endunless -%}
