{%- liquid
  assign section_color = section.settings.color_scheme
  assign heading_size_class = section.settings.heading_size
  assign autoplay = section.settings.autoplay

  assign image_size_mobile = section.settings.image_size_mobile
  assign image_size_desktop = section.settings.image_size_desktop

  capture size_classes
    render 'banner-media-classes', image_size: image_size_mobile, image_size_desktop: image_size_desktop
  endcapture

  if autoplay
    assign no_border_on_slide = true
  endif

  assign has_multiple_slides = false

  if section.blocks.size > 1
    assign has_multiple_slides = true
  endif

  if has_multiple_slides
    assign container_classes = 'pb-slide-controls border-b-gridline border-gridline-color'
  else
    if autoplay
      unless section.blocks.size == 0
        assign container_classes = 'border-b-gridline border-gridline-color'
      endunless
    endif
  endif
-%}

{%- # white-space: normal -%}
{%- capture slide_blocks -%}
  {% for block in section.blocks %}
    {%- liquid
      assign preload = false
      assign loading = 'lazy'
      assign content_position = block.settings.content_position
      assign content_width_desktop = block.settings.content_width_desktop
      assign color_scheme = block.settings.color_scheme
      assign scheme_text_color_only = block.settings.scheme_text_color_only
      assign image = block.settings.image
      assign image_mobile = block.settings.image_mobile
      assign deep_inset = block.settings.deep_inset
      assign title = block.settings.title
      assign text = block.settings.text
      assign subheading = block.settings.subheading
      assign cta_link = block.settings.cta_link
      assign cta_text = block.settings.cta_text
      assign cta_style = block.settings.cta_style
      assign cta_button_style = block.settings.cta_button_style

      if forloop.first
        assign image_ratio_desktop = image.aspect_ratio | default: '4/3'
        assign image_ratio_mobile = image_mobile.aspect_ratio | default: '4/3'

        if section.index == 1
          assign preload = true
        endif

        if section.index <= 3
          assign loading = 'eager'
        endif
      endif
    -%}

    {% if has_multiple_slides %}
      <li
        class="splide__slide{% unless forloop.first %} [.splide:not(.is-active)_&]:hidden{% else %} [.splide:not(.is-active)_&]:w-full{% endunless %}"
        data-index="{{ forloop.index0 }}"
        {{ block.shopify_attributes }}
      >
    {% endif %}
    {%- render 'image-with-text-overlay',
      size_classes: size_classes,
      image: image,
      image_mobile: image_mobile,
      preload: preload,
      no_border: no_border_on_slide,
      content_position: content_position,
      heading_size_class: heading_size_class,
      section_color_scheme: section_color,
      color_scheme: color_scheme,
      scheme_text_color_only: scheme_text_color_only,
      content_width_desktop: content_width_desktop,
      title: title,
      subheading: subheading,
      text: text,
      cta_link: cta_link,
      cta_text: cta_text,
      cta_style: cta_style,
      cta_button_style: cta_button_style,
      loading: loading,
      is_deep_inset: deep_inset
    -%}
    {% if has_multiple_slides %}
      </li>
    {% endif %}
  {% endfor %}
{%- endcapture -%}

<section
  class="relative bg-scheme-background text-scheme-text {{ container_classes }}"
  data-color-scheme="{{ section_color }}"
  style="--media-aspect-ratio: {{ image_ratio_mobile }}; --media-aspect-ratio-desktop: {{ image_ratio_desktop }};"
>
  {% if has_multiple_slides %}
    <data-island
      x-data="
        Slideshow({
          autoplay: {{ autoplay }},
          autoplayInterval: {{ section.settings.autoplay_interval }},
        })
      "
      {% if request.design_mode %}
        on="idle"
      {% endif %}
      class="splide [&.splide]:visible"
    >
      {% if autoplay %}
        <button
          class="absolute left-0 top-0 z-10 p-2"
          type="button"
          aria-label="{{ 'sections.slideshow.pause_slideshow' | t }}"
          data-play="{{ 'sections.slideshow.rotate_slideshow' | t }}"
          data-pause="{{ 'sections.slideshow.pause_slideshow' | t }}"
        >
          <span class="button__icon relative flex items-center justify-center">
            <span
              x-show="playing"
              style="display: none;"
              class="inline-block w-6"
            >
              {%- render 'icon-pause' -%}
            </span>
            <span x-show="!playing" class="inline-block w-6">
              {%- render 'icon-play' -%}
            </span>
          </span>
        </button>
      {% endif %}

      <div class="splide__track">
        <ul class="splide__list">
          {{ slide_blocks }}
        </ul>
      </div>
      {% if autoplay %}
        <div class="bg-gridline-color/30">
          <div
            style="width: 0%;"
            :style="{ width : `${rate * 100}%` }"
            class="progress-bar h-gridline transform-gpu bg-gridline-color will-change-[width]"
          ></div>
        </div>
      {% endif %}

      <data-island
        class="mx-1 mt-2 grid grid-cols-[minmax(0,_1fr)_auto] no-js:hidden lg:mx-4 {% if settings.slideshow_pagination_style == 'dots' %}gap-2{% else %}gap-3 md:gap-10{% endif %}"
        x-data="SlideshowPagination"
        x-init="checkIfWrapped"
        @resize.window.debounce.250="checkIfWrapped"
      >
        <ul x-ref="pagination" class="splide__pagination">
          {% for i in (1..section.blocks.size) %}
            <li
              data-splide-pagination-placeholder
              aria-hidden="true"
            >
              <div class="splide__pagination__page"></div>
            </li>
          {% endfor %}
        </ul>
        <div
          class="splide__arrows col-end-last flex items-center justify-end gap-1 text-scheme-text"
          :class="{ 'items-start pt-[--arrows-wrapped-top-offset]' : paginationIsWrapped, 'items-center' : !paginationIsWrapped }"
        >
          <button class="splide__arrow splide__arrow--prev w-8">
            <span class="sr-only">
              {{- 'sections.slideshow.previous_slide' | t -}}
            </span>
            <span class="block">
              {% render 'icon-arrow-left' %}
            </span>
          </button>
          <button class="splide__arrow splide__arrow--next w-8">
            <span class="sr-only">
              {{- 'sections.slideshow.next_slide' | t -}}
            </span>
            <span class="block">
              {% render 'icon-arrow-right' %}
            </span>
          </button>
        </div>
      </data-island>
    </data-island>
  {% else %}
    {{ slide_blocks }}
  {% endif %}
</section>

{% schema %}
{
  "name": "Slideshow",
  "disabled_on": {
    "groups": [
      "header",
      "footer",
      "aside"
    ]
  },
  "max_blocks": 5,
  "settings": [
    {
      "type": "select",
      "id": "image_size_desktop",
      "label": "Desktop height",
      "options": [
        {
          "value": "natural",
          "label": "Adapt to first slide",
          "group": "No cropping"
        },
        {
          "value": "full_screen",
          "label": "Full screen",
          "group": "Screen height"
        },
        {
          "value": "three_quarters_screen",
          "label": "3/4 screen",
          "group": "Screen height"
        },
        {
          "value": "two_thirds_screen",
          "label": "2/3 screen",
          "group": "Screen height"
        },
        {
          "value": "half_screen",
          "label": "1/2 screen",
          "group": "Screen height"
        },
        {
          "value": "600px",
          "label": "600px",
          "group": "Fixed height"
        },
        {
          "value": "700px",
          "label": "700px",
          "group": "Fixed height"
        },
        {
          "value": "800px",
          "label": "800px",
          "group": "Fixed height"
        },
        {
          "value": "standard",
          "label": "Standard (4:3)",
          "group": "Aspect ratios"
        },
        {
          "value": "widescreen",
          "label": "Widescreen (16:9)",
          "group": "Aspect ratios"
        },
        {
          "value": "cinema",
          "label": "Cinema (1.85:1)",
          "group": "Aspect ratios"
        },
        {
          "value": "ultrawide",
          "label": "Ultrawide (2.35:1)",
          "group": "Aspect ratios"
        }
      ],
      "default": "full_screen"
    },
    {
      "type": "select",
      "id": "image_size_mobile",
      "label": "Mobile height",
      "options": [
        {
          "value": "natural",
          "label": "Adapt to first slide"
        },
        {
          "value": "full_screen",
          "label": "Full screen",
          "group": "Screen height"
        },
        {
          "value": "three_quarters_screen",
          "label": "3/4 screen",
          "group": "Screen height"
        },
        {
          "value": "two_thirds_screen",
          "label": "2/3 screen",
          "group": "Screen height"
        },
        {
          "value": "half_screen",
          "label": "1/2 screen",
          "group": "Screen height"
        },
        {
          "value": "600px",
          "label": "600px",
          "group": "Fixed height"
        },
        {
          "value": "700px",
          "label": "700px",
          "group": "Fixed height"
        },
        {
          "value": "800px",
          "label": "800px",
          "group": "Fixed height"
        },
        {
          "value": "full_portrait",
          "label": "Full portrait (9:16)",
          "group": "Aspect ratios"
        },
        {
          "value": "portrait",
          "label": "Portrait (4:5)",
          "group": "Aspect ratios"
        },
        {
          "value": "square",
          "label": "Square (1:1)",
          "group": "Aspect ratios"
        },
        {
          "value": "standard",
          "label": "Standard (4:3)",
          "group": "Aspect ratios"
        },
        {
          "value": "widescreen",
          "label": "Widescreen (16:9)",
          "group": "Aspect ratios"
        }
      ],
      "default": "full_screen"
    },
    {
      "type": "select",
      "id": "heading_size",
      "label": "Heading size",
      "options": [
        {
          "value": "text-heading-standard",
          "label": "Standard"
        },
        {
          "value": "text-heading-feature",
          "label": "Feature"
        },
        {
          "value": "text-heading-secondary",
          "label": "Secondary"
        }
      ],
      "default": "text-heading-feature"
    },
    {
      "type": "checkbox",
      "id": "autoplay",
      "label": "Auto-rotate slides",
      "info": "This will show a play and pause button and disable dragging."
    },
    {
      "type": "select",
      "id": "autoplay_interval",
      "label": "Change slides every",
      "options": [
        {
          "value": "5000",
          "label": "5 Seconds"
        },
        {
          "value": "6000",
          "label": "6 Seconds"
        },
        {
          "value": "7000",
          "label": "7 Seconds"
        },
        {
          "value": "8000",
          "label": "8 Seconds"
        },
        {
          "value": "9000",
          "label": "9 Seconds"
        },
        {
          "value": "10000",
          "label": "10 Seconds"
        }
      ]
    },
    {
      "type": "header",
      "content": "Color"
    },
    {
      "type": "color_scheme",
      "id": "color_scheme",
      "default": "scheme1",
      "label": "Color scheme"
    }
  ],
  "blocks": [
    {
      "type": "slide",
      "name": "Slide",
      "settings": [
        {
          "id": "image",
          "type": "image_picker",
          "label": "Image",
          "info": "Landscape-orientation JPG of at least 3,600 × 1,600 pixels recommended"
        },
        {
          "id": "image_mobile",
          "type": "image_picker",
          "label": "Mobile image",
          "info": "Portrait-orientation JPG of at least 1,600 × 2,400 pixels recommended"
        },
        {
          "type": "checkbox",
          "id": "deep_inset",
          "label": "Deep inset",
          "default": false
        },
        {
          "type": "header",
          "content": "Content"
        },
        {
          "visible_if": "{{ block.settings.title != blank }}",
          "type": "text",
          "id": "subheading",
          "label": "Subheading"
        },
        {
          "type": "text",
          "id": "title",
          "label": "Heading",
          "default": "Image slide"
        },
        {
          "type": "richtext",
          "id": "text",
          "label": "Text",
          "default": "<p>Use this text to share information about your brand with your customers. Describe a product, share announcements, or welcome customers to your store.</p>"
        },
        {
          "type": "select",
          "id": "content_position",
          "label": "Position",
          "options": [
            {
              "value": "justify-start items-start text-left",
              "label": "Top left"
            },
            {
              "value": "justify-center items-start text-center",
              "label": "Top center"
            },
            {
              "value": "justify-end items-start text-right",
              "label": "Top right"
            },
            {
              "value": "justify-start items-center text-left",
              "label": "Left"
            },
            {
              "value": "justify-center items-center text-center",
              "label": "Center"
            },
            {
              "value": "justify-end items-center text-right",
              "label": "Right"
            },
            {
              "value": "justify-start items-end text-left",
              "label": "Bottom left"
            },
            {
              "value": "justify-center items-end text-center",
              "label": "Bottom center"
            },
            {
              "value": "justify-end items-end text-right",
              "label": "Bottom right"
            }
          ],
          "default": "justify-center items-center text-center"
        },
        {
          "type": "select",
          "id": "content_width_desktop",
          "label": "Width on desktop",
          "default": "lg:w-2/3",
          "options": [
            {
              "value": "lg:w-1/3",
              "label": "One third"
            },
            {
              "value": "lg:w-1/2",
              "label": "One half"
            },
            {
              "value": "lg:w-2/3",
              "label": "Two thirds"
            },
            {
              "value": "lg:w-full",
              "label": "Full width"
            }
          ]
        },
        {
          "type": "header",
          "content": "Call to action"
        },
        {
          "type": "url",
          "id": "cta_link",
          "label": "Link"
        },
        {
          "type": "text",
          "id": "cta_text",
          "label": "Text"
        },
        {
          "type": "select",
          "id": "cta_style",
          "label": "Style",
          "options": [
            {
              "value": "link",
              "label": "Link"
            },
            {
              "value": "button",
              "label": "Button"
            }
          ],
          "default": "link"
        },
        {
          "visible_if": "{{ block.settings.cta_style == 'button' }}",
          "type": "select",
          "id": "cta_button_style",
          "label": "Button style",
          "default": "secondary",
          "options": [
            {
              "value": "primary",
              "label": "Primary"
            },
            {
              "value": "secondary",
              "label": "Secondary"
            }
          ]
        },
        {
          "type": "header",
          "content": "Color"
        },
        {
          "type": "color_scheme",
          "id": "color_scheme",
          "default": "scheme1",
          "label": "Color scheme"
        },
        {
          "id": "scheme_text_color_only",
          "type": "checkbox",
          "label": "Apply text color only",
          "default": false
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Slideshow",
      "category": "Banners",
      "blocks": [
        {
          "type": "slide"
        },
        {
          "type": "slide"
        },
        {
          "type": "slide"
        }
      ]
    }
  ]
}
{% endschema %}
