{%- liquid
  assign section_color = section.settings.color_scheme
  assign image_position = section.settings.image_position
  assign image = section.settings.image
  assign image_mobile = section.settings.image_mobile
  assign crop_image = section.settings.crop_image
  assign show_product_thumbnail = section.settings.show_product_thumbnail
  assign thumbnail_aspect = section.settings.thumbnail_aspect
  assign show_vendor = section.settings.show_vendor
  assign use_large_hotspot_desktop = section.settings.use_large_hotspot_desktop
  assign desktop_alignment = section.settings.desktop_alignment
  assign text = section.settings.text
  assign deep_inset = section.settings.deep_inset

  assign ratio = crop_image | plus: 0
  assign sizes = '(min-width: 1024px) calc(100vw / 2), 100vw'
  if show_product_thumbnail
    assign product_thumbnail_sizes = '4rem'
  endif

  if section.index == 1
    assign preload = true
  else
    assign preload = false
  endif

  assign loading = 'lazy'
  if section.index <= 3
    assign loading = 'eager'
  endif

  if image_position == 'right'
    assign image_width_desktop = 'lg:col-start-7 lg:col-end-13'
  else
    assign image_width_desktop = 'lg:col-span-6'
  endif

  assign hotspot_style_classes = 'relative aspect-square min-h-6 min-w-6 min-touch-target rounded-full'
  if use_large_hotspot_desktop
    assign hotspot_style_classes = hotspot_style_classes | append: ' lg:min-h-8 lg:min-w-8'
  endif

  assign image_container_classes = 'relative border-b-gridline border-gridline-color'

  if deep_inset
    assign image_container_classes = image_container_classes | append: ' p-deep-inset-media'
  else
    assign image_container_classes = image_container_classes | append: ' p-grid-media'
  endif
-%}

{% assign hotspots = '' %}
{% assign product_list = '' %}

{% for block in section.blocks %}
  {% liquid
    assign product = block.settings.product
    assign y_position = block.settings.y_position
    assign x_position = block.settings.x_position
    assign use_mobile_position = block.settings.use_mobile_position
    assign x_position_mobile = block.settings.x_position_mobile
    assign y_position_mobile = block.settings.y_position_mobile

    assign sold_out = true
    if product.available
      assign sold_out = false
    endif

    assign on_sale = false
    if product.compare_at_price > product.price
      assign on_sale = true
    endif
  %}

  {%- # white-space: normal -%}
  {% capture hotspot %}
    <div
      style="--top: {{ y_position }}%; --left: {{ x_position }}%; {% if use_mobile_position %}--mobile-top: {{ y_position_mobile }}%; --mobile-left: {{ x_position_mobile }}%;{% endif %}"
      class="absolute {% if use_mobile_position %}left-[--mobile-left] top-[--mobile-top] lg:left-[--left] lg:top-[--top]{% else %}left-[--left] top-[--top]{% endif %} -translate-x-1/2 -translate-y-1/2"
    >
      {% if product == blank %}
        <div
          aria-hidden="true"
          class="{{ hotspot_style_classes }} bg-scheme-text text-scheme-background"
        >
      {% else %}
        <a
          tabindex="-1"
          x-on:mouseenter="currentProduct = '{{- product.handle -}}'"
          x-on:mouseleave="setTimeout(() => { if(currentProduct == '{{ product.handle }}') {currentProduct = ''}  }, 200)"
          x-on:focus="currentProduct = '{{- product.handle -}}'"
          x-on:blur="setTimeout(() => { if(currentProduct == '{{ product.handle }}') {currentProduct = ''}  }, 200)"
          href="{{ product.url }}"
          aria-hidden="true"
          :class="currentProduct === '{{ product.handle }}' ? 'bg-scheme-accent text-scheme-accent-contrast' : 'bg-scheme-text text-scheme-background'"
          class="block {{ hotspot_style_classes }}"
        >
      {% endif %}
      <span
        class="absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 text-base"
      >
        {{- forloop.index -}}
      </span>
      {% if product == blank %}
        </div>
      {% else %}
        </a>
      {% endif %}
    </div>
  {% endcapture %}
  {% assign hotspots = hotspots | append: hotspot %}

  {%- # white-space: normal -%}
  {% capture product_list_item %}
    <li
      class="border-t-gridline border-gridline-color px-section-horizontal-spacing py-section-vertical-spacing"
    >
      {% if product == blank %}
        <div aria-hidden="true" class="flex justify-between gap-2">
      {% else %}
        <a
          x-on:mouseenter="currentProduct = '{{- product.handle -}}'"
          x-on:mouseleave="setTimeout(() => { if(currentProduct == '{{ product.handle }}') {currentProduct = ''}  }, 200)"
          x-on:focus="currentProduct = '{{- product.handle -}}'"
          x-on:blur="setTimeout(() => { if(currentProduct == '{{ product.handle }}') {currentProduct = ''}  }, 200)"
          href="{{ product.url }}"
          :class="currentProduct === '{{ product.handle }}' ? 'text-scheme-accent' : 'text-scheme-text'"
          class="flex justify-between gap-2"
        >
      {% endif %}
      <div class="flex w-full items-start justify-between gap-2 text-left lg:gap-4">
        <div
          class="block self-start {{ hotspot_style_classes }} {% if product == blank %}bg-scheme-text text-scheme-background{% endif %}"
          {% unless product == blank %}
            :class="currentProduct === '{{ product.handle }}' ? 'bg-scheme-accent text-scheme-accent-contrast' : 'bg-scheme-text text-scheme-background'"
          {% endunless %}
        >
          <span
            aria-hidden="true"
            class="absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 text-base"
          >
            {{- forloop.index -}}
          </span>
        </div>
        <div class="flex flex-1 flex-col gap-1">
          {% if show_vendor %}
            {% if product != blank %}
              {%- if product.vendor != '' -%}
                <div>
                  <p class="break-word {% if sold_out %}line-through{% endif %}">
                    {{ product.vendor }}
                  </p>
                </div>
              {%- endif -%}
            {% else %}
              <div>
                {{- 'products.product.vendor' | t -}}
              </div>
            {% endif %}
          {% endif %}

          {% if product != blank %}
            <div>
              <p class="break-word {% if sold_out %}line-through{% endif %}">
                {{ product.title }}
              </p>
            </div>
            {%- render 'table-price',
              product: product,
              sold_out: sold_out,
              on_sale: on_sale
            -%}
          {% else %}
            <div>{{ 'homepage.onboarding.product_title' | t }}</div>
            <div>
              {%- if settings.currency_code_enabled == true -%}
                {{- 1999 | money_with_currency -}}
              {%- else -%}
                {{- 1999 | money -}}
              {%- endif -%}
            </div>
          {% endif %}
        </div>
      </div>

      {% if show_product_thumbnail %}
        <div
          class="relative h-full min-w-16"
          style="aspect-ratio: {{ thumbnail_aspect }} / 1"
        >
          {% if product != blank %}
            {% render 'image-fill',
              image: product.featured_image,
              sizes: product_thumbnail_sizes,
              preload: false,
              loading: loading,
              is_thumbnail: true
            %}
          {% else %}
            {%- render 'image-crop-placeholder', is_thumbnail: true -%}
          {% endif %}
        </div>
      {% endif %}
      {% if product == blank %}
        </div>
      {% else %}
        </a>
      {% endif %}
    </li>
  {% endcapture %}
  {% assign product_list = product_list | append: product_list_item %}
{% endfor %}

<section class="bg-scheme-background text-scheme-text">
  {% if section.settings.title != '' %}
    {%- render 'section-header',
      title: section.settings.title,
      section_color: section_color,
      subheading: section.settings.subheading
    -%}
  {% endif %}

  <div
    x-data="{ currentProduct: '' }"
    class="grid grid-flow-row-dense grid-cols-1 gap-gutter overflow-hidden border-b-gridline border-gridline-color bg-gridline-color lg:grid-cols-12"
    data-color-scheme="{{ section_color }}"
  >
    <div
      class="grid h-full {{ image_width_desktop }}"
    >
      <div class="relative col-start-1 row-start-1 {% if text == blank %}-mb-gridline{% else %}lg:-mb-gridline{% endif %} min-h-full bg-scheme-background lg:-mt-gridline">
        {% if image != blank %}
          <div
            class="{{ image_container_classes }} {% if image_mobile != blank %}hidden lg:block{% endif %}"
          >
            {% render 'image-crop',
              image: image,
              sizes: sizes,
              preload: preload,
              ratio: ratio,
              is_deep_inset: deep_inset,
              hotspots: hotspots
            %}
          </div>
          {% if image_mobile != blank %}
            <div class="lg:hidden {{ image_container_classes }}">
              {% assign image = image_mobile %}
              {% render 'image-crop',
                image: image,
                sizes: sizes,
                preload: preload,
                ratio: ratio,
                is_deep_inset: deep_inset,
                hotspots: hotspots
              %}
            </div>
          {% endif %}

        {% else %}
          <div
            class="{{ image_container_classes }}"
          >
            {%- render 'image-crop-placeholder',
              is_deep_inset: deep_inset,
              hotspots: hotspots
            -%}
          </div>
        {% endif %}
      </div>
    </div>

    <div
      class="relative -mb-gridline -mt-gridline bg-scheme-background text-scheme-text lg:col-span-6"
    >
      <div class="flex h-full flex-col {% if text == blank %}{% if desktop_alignment == 'bottom' %}lg:justify-end{% endif %}{% else %}lg:justify-between{% endif %}">
        {% unless text == blank %}
          <div class="rte px-section-horizontal-spacing py-section-vertical-spacing {% if desktop_alignment == 'top' %}lg:order-2{% endif %}">
            {{ text }}
          </div>
        {% endunless %}
        <ul class="h-fit w-full border-b-gridline border-gridline-color">
          {{ product_list }}
        </ul>
      </div>
    </div>
  </div>
</section>

{% schema %}
{
  "name": "Shop the look",
  "disabled_on": {
    "groups": [
      "header",
      "footer",
      "aside"
    ]
  },
  "settings": [
    {
      "id": "image",
      "type": "image_picker",
      "label": "Desktop image"
    },
    {
      "id": "image_mobile",
      "type": "image_picker",
      "label": "Mobile image",
      "info": "Optional."
    },
    {
      "type": "select",
      "id": "crop_image",
      "label": "Crop image",
      "options": [
        {
          "value": "0",
          "label": "Natural"
        },
        {
          "value": "1",
          "label": "Square"
        },
        {
          "value": "0.8",
          "label": "Portrait"
        },
        {
          "value": "1.3",
          "label": "Landscape"
        }
      ],
      "default": "1"
    },
    {
      "type": "checkbox",
      "id": "deep_inset",
      "label": "Deep inset",
      "default": false
    },
    {
      "type": "select",
      "id": "image_position",
      "label": "Image position on desktop",
      "default": "right",
      "options": [
        {
          "value": "right",
          "label": "Right"
        },
        {
          "value": "left",
          "label": "Left"
        }
      ]
    },
    {
      "type": "richtext",
      "id": "text",
      "label": "Text",
      "default": "<p>Use this text to share information about your brand with your customers. Describe a product, share announcements, or welcome customers to your store.</p>"
    },
    {
      "type": "header",
      "content": "Hotspots"
    },
    {
      "type": "checkbox",
      "id": "use_large_hotspot_desktop",
      "label": "Use larger hotspot on desktop",
      "default": false
    },
    {
      "type": "header",
      "content": "Product list"
    },
    {
      "type": "checkbox",
      "id": "show_product_thumbnail",
      "label": "Show product thumbnail"
    },
    {
      "visible_if": "{{ section.settings.show_product_thumbnail }}",
      "type": "select",
      "id": "thumbnail_aspect",
      "label": "Product thumbnail crop",
      "options": [
        {
          "value": "1",
          "label": "Square"
        },
        {
          "value": "0.8",
          "label": "Portrait"
        }
      ],
      "default": "1"
    },
    {
      "type": "checkbox",
      "id": "show_vendor",
      "label": "Show vendor",
      "default": false
    },
    {
      "type": "select",
      "id": "desktop_alignment",
      "label": "Desktop alignment",
      "options": [
        {
          "value": "top",
          "label": "Top"
        },
        {
          "value": "bottom",
          "label": "Bottom"
        }
      ],
      "default": "bottom"
    },
    {
      "type": "header",
      "content": "Header"
    },
    {
      "visible_if": "{{ section.settings.title != blank }}",
      "type": "text",
      "id": "subheading",
      "label": "Subheading"
    },
    {
      "type": "text",
      "id": "title",
      "label": "Heading",
      "default": "Shop the look"
    },
    {
      "type": "header",
      "content": "Color"
    },
    {
      "type": "color_scheme",
      "id": "color_scheme",
      "default": "scheme1",
      "label": "Color scheme"
    }
  ],
  "blocks": [
    {
      "name": "Product",
      "type": "product_hotspot",
      "limit": 6,
      "settings": [
        {
          "type": "product",
          "id": "product",
          "label": "Product"
        },
        {
          "type": "range",
          "id": "x_position",
          "min": 0,
          "max": 100,
          "step": 1,
          "label": "Horizontal position",
          "default": 50,
          "unit": "%"
        },
        {
          "type": "range",
          "id": "y_position",
          "min": 0,
          "max": 100,
          "step": 1,
          "label": "Vertical position",
          "default": 50,
          "unit": "%"
        },
        {
          "type": "header",
          "content": "Mobile"
        },
        {
          "type": "checkbox",
          "id": "use_mobile_position",
          "label": "Use different position on mobile",
          "default": false
        },
        {
          "visible_if": "{{ block.settings.use_mobile_position }}",
          "type": "range",
          "id": "x_position_mobile",
          "min": 0,
          "max": 100,
          "step": 1,
          "label": "Horizontal position",
          "default": 25,
          "unit": "%"
        },
        {
          "visible_if": "{{ block.settings.use_mobile_position }}",
          "type": "range",
          "id": "y_position_mobile",
          "min": 0,
          "max": 100,
          "step": 1,
          "label": "Vertical position",
          "default": 50,
          "unit": "%"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Shop the look",
      "category": "Products",
      "blocks": [
        {
          "type": "product_hotspot",
          "settings": {
            "x_position": 25,
            "y_position": 50
          }
        },
        {
          "type": "product_hotspot",
          "settings": {
            "x_position": 66,
            "y_position": 33
          }
        },
        {
          "type": "product_hotspot",
          "settings": {
            "x_position": 82,
            "y_position": 82
          }
        }
      ]
    }
  ]
}
{% endschema %}
