{%- liquid
  assign section_color = section.settings.color_scheme
  assign text_align = section.settings.text_alignment
  assign ratio = section.settings.crop | plus: 0
  assign mobile_product_tile_width = section.settings.mobile_product_tile_width
  assign desktop_product_tile_width = section.settings.desktop_product_tile_width
  assign block_heading_level = 'h2'
  assign spread = section.settings.spread

  assign eager_loading_limit = section.blocks.size | at_most: 4
  assign sizes = '(min-width: 1024px) ' | append: desktop_product_tile_width | append: 'vw'

  case mobile_product_tile_width
    when '60'
      assign sizes = sizes | append: ', 60vw'
      assign lazy_loading_limit = 2
    when '80'
      assign sizes = sizes | append: ', 80vw'
      assign lazy_loading_limit = 2
    when '100'
      assign sizes = sizes | append: ', 100vw'
      assign lazy_loading_limit = 1
  endcase
-%}

<section
  class="border-b-gridline border-gridline-color"
  data-color-scheme="{{ section_color }}"
  style="--mobile-slide-width: {{ mobile_product_tile_width }}%; --desktop-slide-width: {{ desktop_product_tile_width }}%;"
>
  {% if section.settings.title != '' %}
    {%- assign block_heading_level = 'h3' -%}
    {%- render 'section-header',
      title: section.settings.title,
      section_color: section_color,
      subheading: section.settings.subheading
    -%}
  {% endif %}

  <div class="bg-scheme-background pb-slide-controls">
    <data-island
      x-data="
        Slideshow({
          autoplay: false,
          autoplayInterval: false,
          gap: 'var(--gridline-width)',
          mode: 'carousel',
          onlyIfNeeded: true,
        })
      "
      class="splide"
    >
      <div
        class="splide__track bg-gridline-color no-js:[.splide:not(.is-active)_&]:visible [.splide:not(.is-active,_.is-initialized)_&]:invisible"
      >
        <ul class="splide__list no-js:gap-gridline no-js:overflow-x-auto [.splide.is-active_&]:cursor-grab [.splide:not(.is-active)_&]:!flex [.splide:not(.is-active)_&]:gap-gridline">
          {% for block in section.blocks %}
            {%- liquid
              assign loading = 'lazy'

              if section.index <= 3 and forloop.index <= lazy_loading_limit
                assign loading = 'eager'
              endif

              if section.index == 1 and forloop.first
                assign preload = true
              else
                assign preload = false
              endif
            -%}

            {%- case block.type -%}
              {%- when 'image' -%}
                <li
                  class="splide__slide w-[var(--mobile-slide-width)] border-b-gridline border-gridline-color bg-scheme-background text-base text-scheme-text no-js:!block lg:w-[var(--desktop-slide-width)]"
                  {{ block.shopify_attributes }}
                >
                  <div class="-mb-gridline h-fit w-full border-b-gridline border-gridline-color bg-scheme-background p-grid-media">
                    {%- liquid
                      if block.settings.image != blank
                        assign preload = false
                        assign loading = 'lazy'

                        if section.index == 1 and forloop.first
                          assign preload = true
                        endif

                        if section.index <= 2 and forloop.index <= eager_loading_limit
                          assign loading = 'eager'
                        endif

                        render 'image-crop', image: block.settings.image, ratio: ratio, sizes: sizes, preload: preload, loading: loading

                      else
                        render 'image-crop-placeholder', ratio: ratio
                      endif
                    -%}
                  </div>
                </li>

              {%- when 'text' -%}
                {%- liquid
                  assign block_color = block.settings.color_scheme
                  assign title = block.settings.title
                  assign text = block.settings.text
                  assign cta_link = block.settings.cta_link

                  if spread
                    assign spread_classes = 'flex h-full flex-col'
                  endif
                -%}

                <li
                  class="splide__slide w-[var(--mobile-slide-width)] border-b-gridline border-gridline-color bg-scheme-background text-base text-scheme-text no-js:!block lg:w-[var(--desktop-slide-width)] {{ text_align }}"
                  data-color-scheme="{{ block_color }}"
                  {{ block.shopify_attributes }}
                >
                  <div class="h-full px-section-horizontal-spacing py-section-vertical-spacing {{ spread_classes }} {% if spread and cta_link != blank and title != blank and text != blank %}justify-between{% endif %}">
                    <div class="{{ spread_classes }} {% if spread and cta_link == blank %}justify-between{% endif %}">
                      {% if title != '' %}
                        <{{ block_heading_level }} class="font-heading text-heading-secondary">
                          {{- title -}}
                        </{{ block_heading_level }}>
                      {% endif %}
                      <div class="rte {% if title != '' %}mt-2{% endif %}">
                        {{ text }}
                      </div>
                    </div>
                    {% if cta_link %}
                      <div
                        class="{% if title != blank or text != blank %}mt-cta{% endif %}"
                      >
                        <a
                          class="theme-link inline-block text-scheme-text hover:text-scheme-accent"
                          href="{{ cta_link }}"
                        >
                          {{- block.settings.cta_text -}}
                        </a>
                      </div>
                    {% endif %}
                  </div>
                </li>
            {%- endcase -%}
          {%- endfor -%}

          <li
            style="--mobile-placeholder-width: calc(100% - (({{  section.blocks.size }} * {{ mobile_product_tile_width }}%) - ({{  section.blocks.size | minus: 1 }} * var(--gridline-width)))); --desktop-placeholder-width: calc(100% - (({{  section.blocks.size }} * {{ desktop_product_tile_width }}%) - ({{  section.blocks.size | minus: 1 }} * var(--gridline-width))));"
            class="w-[--mobile-placeholder-width] border-b-gridline border-gridline-color bg-scheme-background lg:w-[--desktop-placeholder-width]"
            aria-hidden="true"
            role="presentation"
          ></li>
        </ul>
      </div>

      <data-island
        class="mx-1 mt-2 grid grid-cols-[minmax(0,_1fr)_auto] gap-x-2 gap-y-0 text-scheme-text no-js:hidden lg:mx-4"
        x-data="
          {
            paginationIsWrapped: false,
            checkIfWrapped() {
              this.paginationIsWrapped = hasWrappedChildren(this.$refs.pagination)
            }
          }
        "
        x-init="checkIfWrapped"
        @resize.window.debounce.250="checkIfWrapped"
      >
        <ul x-ref="pagination" class="splide__pagination">
          {% for i in (1..section.blocks.size) %}
            <li
              data-splide-pagination-placeholder
              aria-hidden="true"
            >
              <div class="splide__pagination__page"></div>
            </li>
          {% endfor %}
        </ul>

        <div
          class="splide__arrows col-end-last flex items-center justify-end gap-1 text-scheme-text [.splide:not(.is-active)_&]:pointer-events-none [.splide:not(.is-active)_&]:invisible"
          :class="{ 'items-start pt-[--arrows-wrapped-top-offset]' : paginationIsWrapped, 'items-center' : !paginationIsWrapped }"
        >
          <button class="splide__arrow splide__arrow--prev w-8">
            <span class="sr-only">
              {{- 'sections.slideshow.previous_slide' | t -}}
            </span>
            <span class="block">
              {% render 'icon-arrow-left' %}
            </span>
          </button>
          <button class="splide__arrow splide__arrow--next w-8">
            <span class="sr-only">
              {{- 'sections.slideshow.next_slide' | t -}}
            </span>
            <span class="block">
              {% render 'icon-arrow-right' %}
            </span>
          </button>
        </div>
      </data-island>
    </data-island>
  </div>
</section>

{% schema %}
{
  "name": "Text and image carousel",
  "disabled_on": {
    "groups": [
      "header",
      "footer",
      "aside"
    ]
  },
  "settings": [
    {
      "type": "header",
      "content": "Block width"
    },
    {
      "type": "select",
      "id": "mobile_product_tile_width",
      "label": "Mobile",
      "options": [
        {
          "value": "60",
          "label": "60%"
        },
        {
          "value": "80",
          "label": "80%"
        },
        {
          "value": "100",
          "label": "100%"
        }
      ],
      "default": "80"
    },
    {
      "type": "range",
      "id": "desktop_product_tile_width",
      "label": "Desktop",
      "min": 20,
      "max": 40,
      "step": 2,
      "default": 30,
      "unit": "%"
    },
    {
      "type": "header",
      "content": "Image"
    },
    {
      "type": "select",
      "id": "crop",
      "label": "Crop",
      "options": [
        {
          "value": "1.3",
          "label": "Landscape"
        },
        {
          "value": "1",
          "label": "Square"
        },
        {
          "value": "0.8",
          "label": "Portrait"
        }
      ],
      "default": "1"
    },
    {
      "type": "header",
      "content": "Text"
    },
    {
      "type": "select",
      "id": "text_alignment",
      "label": "Horizontal alignment",
      "options": [
        {
          "value": "text-left",
          "label": "Left"
        },
        {
          "value": "text-center",
          "label": "Center"
        },
        {
          "value": "text-right",
          "label": "Right"
        }
      ],
      "default": "text-left"
    },
    {
      "type": "checkbox",
      "id": "spread",
      "label": "Spread content",
      "default": false
    },
    {
      "type": "header",
      "content": "Header"
    },
    {
      "visible_if": "{{ section.settings.title != blank }}",
      "type": "text",
      "id": "subheading",
      "label": "Subheading"
    },
    {
      "type": "text",
      "id": "title",
      "label": "Heading"
    },
    {
      "type": "header",
      "content": "Color"
    },
    {
      "type": "color_scheme",
      "id": "color_scheme",
      "default": "scheme1",
      "label": "Color scheme"
    }
  ],
  "blocks": [
    {
      "type": "image",
      "name": "Image",
      "settings": [
        {
          "id": "image",
          "type": "image_picker",
          "label": "Image"
        }
      ]
    },
    {
      "type": "text",
      "name": "Text",
      "settings": [
        {
          "type": "text",
          "id": "title",
          "label": "Heading"
        },
        {
          "type": "richtext",
          "id": "text",
          "label": "Text",
          "default": "<p>Share blog posts, products, or promotions with your customers. Use this text to describe products, share details on availability and style, or as a space to display recent reviews or FAQs.</p>"
        },
        {
          "type": "header",
          "content": "Call to action"
        },
        {
          "type": "url",
          "id": "cta_link",
          "label": "Link"
        },
        {
          "type": "text",
          "id": "cta_text",
          "label": "Text"
        },
        {
          "type": "header",
          "content": "Color"
        },
        {
          "type": "color_scheme",
          "id": "color_scheme",
          "default": "scheme1",
          "label": "Color scheme"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Text and image carousel",
      "category": "Editorial",
      "blocks": [
        {
          "type": "text"
        },
        {
          "type": "image"
        },
        {
          "type": "text"
        },
        {
          "type": "image"
        },
        {
          "type": "text"
        }
      ]
    }
  ]
}
{% endschema %}
